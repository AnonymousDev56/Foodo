name: Deploy (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      image:
        description: "Optional full image ref (defaults to ghcr latest)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy over SSH
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Resolve image ref
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            echo "IMAGE_REF=${{ inputs.image }}" >> "${GITHUB_ENV}"
          else
            echo "IMAGE_REF=ghcr.io/${{ github.repository_owner }}/foodo-monorepo:latest" >> "${GITHUB_ENV}"
          fi

      - name: Validate deploy secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          missing=0
          for key in DEPLOY_HOST DEPLOY_USER DEPLOY_SSH_KEY DEPLOY_PATH GHCR_USERNAME GHCR_TOKEN; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Deploy
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_REF: ${{ env.IMAGE_REF }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          envs: IMAGE_REF,DEPLOY_PATH,GHCR_USERNAME,GHCR_TOKEN
          script_stop: true
          script: |
            set -euo pipefail
            cd "${DEPLOY_PATH}"
            echo "Deploying image: ${IMAGE_REF}"
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin
            export FOODO_MONOREPO_IMAGE="${IMAGE_REF}"
            docker pull "${FOODO_MONOREPO_IMAGE}"
            docker compose -f infra/docker/docker-compose.yml up -d --remove-orphans --no-build
            docker compose -f infra/docker/docker-compose.yml ps
