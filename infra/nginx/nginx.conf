server {
  listen 80;
  server_name _;
  resolver 127.0.0.11 valid=30s ipv6=off;
  # We run behind a host port mapping (e.g. 8080 -> 80). Relative redirects avoid
  # leaking the internal container port in Location headers.
  absolute_redirect off;

  location = /health {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # API routes.
  location /auth/ {
    proxy_pass http://auth-service:3001/auth/;
  }

  location /orders/ {
    proxy_pass http://orders-service:3002/orders/;
  }

  location /admin/ {
    proxy_pass http://orders-service:3002/admin/;
  }

  location /delivery/ {
    proxy_pass http://delivery-service:3004/delivery/;
  }

  location /products {
    proxy_pass http://warehouse-service:3003/products;
  }

  location /categories {
    proxy_pass http://warehouse-service:3003/categories;
  }

  location /stock/ {
    proxy_pass http://warehouse-service:3003/stock/;
  }

  location /notifications/ {
    proxy_pass http://notification-service:3005/;
  }

  location /telegram/ {
    proxy_pass http://telegram-router:3008/telegram/;
  }

  # WS channels.
  location /orders/ws {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_pass http://orders-service:3002/orders/ws;
  }

  location /ws/admin-dashboard {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_pass http://orders-service:3002/ws/admin-dashboard;
  }

  location /delivery/ws {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_pass http://delivery-service:3004/delivery/ws;
  }

  # Gateway is API/WS-only in rollback mode. Frontends run on their own ports.
  location / {
    return 404;
  }
}
